{% extends "base.html" %}

{% block title %}New Entry - Accounting Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header py-2">
                    <h5 class="mb-1"><i class="fas fa-plus-circle me-2"></i>New Journal Entry</h5>
                    <small class="text-muted">Create a new double-entry journal entry</small>
                </div>
                <div class="card-body p-3">
                    <form method="POST" action="{{ url_for('add_entry') }}" id="entryForm">
                        <!-- Date and Narration -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="entry_date" class="form-label fw-bold small">
                                    <i class="fas fa-calendar me-1"></i>Date
                                </label>
                                <input type="date" class="form-control form-control-sm" 
                                       id="entry_date" name="entry_date" 
                                       value="{{ today_date }}" required>
                            </div>
                            <div class="col-md-9">
                                <label for="narration" class="form-label fw-bold small">
                                    <i class="fas fa-comment me-1"></i>Narration
                                </label>
                                <input type="text" class="form-control form-control-sm" 
                                       id="narration" name="narration" 
                                       placeholder="Enter transaction description..." 
                                       style="background: linear-gradient(135deg, #fff9c4 0%, #fff3b8 100%);"
                                       required>
                            </div>
                        </div>

                        <!-- Accounts Section -->
                        <div class="mb-3">
                            <h6 class="section-title mb-2">
                                <i class="fas fa-list me-2"></i>Account Entries
                            </h6>
                            
                            <div id="accountsContainer">
                                <!-- Account rows will be added by JavaScript -->
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addAccountBtn">
                                <i class="fas fa-plus me-1"></i>Add Account
                            </button>
                        </div>

                        <!-- Running Totals -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="p-2 rounded" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6;">
                                    <h6 class="mb-2 small"><i class="fas fa-calculator me-2"></i>Running Totals</h6>
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="p-1 rounded text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                                <small>Total Debit</small>
                                                <div class="fw-bold" id="totalDebit">₹0.00</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-1 rounded text-white" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
                                                <small>Total Credit</small>
                                                <div class="fw-bold" id="totalCredit">₹0.00</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-1 rounded text-white" id="differenceBox" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                                                <small>Difference</small>
                                                <div class="fw-bold" id="totalDifference">₹0.00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success px-4 me-3">
                                <i class="fas fa-save me-2"></i>Save Entry
                            </button>
                            <button type="button" class="btn btn-warning px-4" id="clearFormBtn">
                                <i class="fas fa-undo me-2"></i>Clear Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="floating-action">
    <a href="{{ url_for('journal') }}" class="btn btn-primary" title="View Journal">
        <i class="fas fa-book"></i>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// Account suggestions - using let to avoid redeclaration errors
let commonAccounts = [
    // Assets
    'Cash', 'Petty Cash', 'Bank', 'SBI Bank', 'HDFC Bank', 'ICICI Bank', 'Axis Bank',
    'Accounts Receivable', 'Sundry Debtors', 'Trade Receivables', 'Notes Receivable',
    'Stock', 'Inventory', 'Raw Materials', 'Finished Goods', 'Work in Progress',
    'Furniture & Fixtures', 'Office Equipment', 'Computer', 'Laptop', 'Machinery',
    'Building', 'Land', 'Vehicle', 'Motor Car', 'Truck', 'Bike',
    'Investment', 'Fixed Deposit', 'Mutual Fund', 'Shares', 'Bonds',
    'Prepaid Rent', 'Prepaid Insurance', 'Security Deposit', 'Advance to Supplier',
    'Goodwill', 'Patent', 'Trademark', 'Software', 'Licenses',
    
    // Liabilities
    'Accounts Payable', 'Sundry Creditors', 'Trade Payables', 'Notes Payable',
    'Bank Loan', 'Personal Loan', 'Home Loan', 'Car Loan', 'Working Capital Loan',
    'Credit Card Outstanding', 'Overdraft', 'Line of Credit',
    'Accrued Expenses', 'Outstanding Expenses', 'Salary Payable', 'Interest Payable',
    'Tax Payable', 'GST Payable', 'TDS Payable', 'Professional Tax Payable',
    'Unearned Revenue', 'Advance from Customer', 'Security from Customer',
    
    // Equity
    'Capital', 'Owner\'s Capital', 'Share Capital', 'Retained Earnings',
    'Drawing', 'Owner\'s Drawing', 'Reserve Fund', 'General Reserve',
    'Revaluation Reserve', 'Capital Reserve', 'Surplus',
    
    // Revenue/Income
    'Sales', 'Sales Revenue', 'Service Revenue', 'Consulting Income',
    'Commission Received', 'Interest Received', 'Rent Received', 'Dividend Received',
    'Discount Received', 'Fees Earned', 'Professional Fees', 'Royalty Income',
    'Other Income', 'Miscellaneous Income', 'Gain on Sale of Asset',
    
    // Expenses
    'Purchases', 'Purchase Returns', 'Cost of Goods Sold', 'Opening Stock', 'Closing Stock',
    'Salary Expense', 'Wages', 'Bonus', 'DA', 'HRA', 'Overtime', 'Staff Welfare',
    'Rent Expense', 'Office Rent', 'Godown Rent', 'Factory Rent',
    'Electricity Expense', 'Water Charges', 'Gas Charges', 'Internet Expense',
    'Telephone Expense', 'Mobile Charges', 'Postage & Courier',
    'Office Expenses', 'Office Supplies', 'Stationery', 'Printing',
    'Advertisement Expense', 'Marketing Expense', 'Promotion Expense',
    'Travel Expense', 'Conveyance', 'Hotel Expense', 'Fuel Expense',
    'Transport Expense', 'Freight', 'Loading & Unloading', 'Cartage',
    'Insurance Expense', 'Vehicle Insurance', 'Fire Insurance', 'Medical Insurance',
    'Professional Fees', 'Audit Fees', 'Legal Fees', 'Consultant Fees',
    'Bank Charges', 'Interest Expense', 'Loan Interest', 'Bank Interest',
    'Repairs & Maintenance', 'Computer Maintenance', 'Vehicle Repairs',
    'Depreciation Expense', 'Depreciation on Building', 'Depreciation on Furniture',
    'Bad Debts', 'Provision for Bad Debts', 'Doubtful Debts',
    'Entertainment Expense', 'Refreshment', 'Business Lunch',
    'Training Expense', 'Conference Expense', 'Subscription',
    'License Fees', 'Registration Fees', 'Penalty', 'Fine',
    'Security Charges', 'Cleaning Charges', 'Housekeeping',
    'Miscellaneous Expense', 'General Expense', 'Other Expense'
];

let accountCounter = 0;

// Clear any existing interval to prevent conflicts
if (window.accountSuggestionsClearer) {
    clearInterval(window.accountSuggestionsClearer);
}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    addAccountRow();
    addAccountRow();
    
    document.getElementById('addAccountBtn').addEventListener('click', addAccountRow);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    document.getElementById('entryForm').addEventListener('submit', validateForm);
    
    // Auto-calculate totals
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('amount-input') || e.target.classList.contains('account-type-select')) {
            calculateTotals();
        }
    });
});

function addAccountRow() {
    accountCounter++;
    
    const container = document.getElementById('accountsContainer');
    const accountRow = document.createElement('div');
    accountRow.className = 'account-row p-2 mb-2 rounded';
    accountRow.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%)';
    accountRow.style.border = '1px solid #e9ecef';
    accountRow.style.transition = 'all 0.3s ease';
    accountRow.dataset.accountId = accountCounter;
    
    accountRow.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-5 mb-2">
                <label class="form-label fw-bold small">Account Name</label>
                <input type="text" class="form-control form-control-sm account-name-input" 
                       name="account_name" 
                       placeholder="Enter account name..."
                       list="accountSuggestions${accountCounter}" required>
                <datalist id="accountSuggestions${accountCounter}">
                    ${commonAccounts.map(account => `<option value="${account}">`).join('')}
                </datalist>
            </div>
            <div class="col-md-2 mb-2">
                <label class="form-label fw-bold small">Type</label>
                <select class="form-select form-select-sm account-type-select" name="account_type" required>
                    <option value="">Type...</option>
                    <option value="debit">Debit</option>
                    <option value="credit">Credit</option>
                </select>
            </div>
            <div class="col-md-4 mb-2">
                <label class="form-label fw-bold small">Amount (₹)</label>
                <input type="number" class="form-control form-control-sm amount-input" 
                       name="account_amount" 
                       placeholder="0.00" 
                       step="0.01" min="0" required>
            </div>
            <div class="col-md-1 mb-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm remove-account-btn" 
                        onclick="removeAccountRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(accountRow);
    
    // Add animation
    accountRow.style.opacity = '0';
    accountRow.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        accountRow.style.opacity = '1';
        accountRow.style.transform = 'translateY(0)';
    }, 10);
    
    // Update styling based on type
    const typeSelect = accountRow.querySelector('.account-type-select');
    typeSelect.addEventListener('change', function() {
        updateAccountRowStyling(accountRow, this.value);
    });
    
    // Focus on new input
    const nameInput = accountRow.querySelector('.account-name-input');
    nameInput.focus();
    
    calculateTotals();
}

function removeAccountRow(button) {
    const accountRow = button.closest('.account-row');
    const container = document.getElementById('accountsContainer');
    
    if (container.children.length > 1) {
        accountRow.style.transition = 'all 0.3s ease';
        accountRow.style.opacity = '0';
        accountRow.style.transform = 'translateX(-100%)';
        
        setTimeout(() => {
            accountRow.remove();
            calculateTotals();
        }, 300);
    } else {
        alert('At least one account entry is required!');
    }
}

function updateAccountRowStyling(row, type) {
    row.classList.remove('debit-row', 'credit-row');
    if (type === 'debit') {
        row.style.borderLeft = '5px solid #28a745';
        row.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
    } else if (type === 'credit') {
        row.style.borderLeft = '5px solid #dc3545';
        row.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
    } else {
        row.style.borderLeft = '2px solid #e9ecef';
        row.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%)';
    }
}

function calculateTotals() {
    let totalDebit = 0;
    let totalCredit = 0;
    
    const accountRows = document.querySelectorAll('.account-row');
    
    accountRows.forEach(row => {
        const typeSelect = row.querySelector('.account-type-select');
        const amountInput = row.querySelector('.amount-input');
        
        const type = typeSelect.value;
        const amount = parseFloat(amountInput.value) || 0;
        
        if (type === 'debit') {
            totalDebit += amount;
        } else if (type === 'credit') {
            totalCredit += amount;
        }
    });
    
    // Update display
    document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
    document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
    
    const difference = Math.abs(totalDebit - totalCredit);
    document.getElementById('totalDifference').textContent = `₹${difference.toFixed(2)}`;
    
    // Update difference styling
    const differenceBox = document.getElementById('differenceBox');
    
    if (difference < 0.01) {
        differenceBox.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    } else {
        differenceBox.style.background = 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)';
    }
}

function clearForm() {
    if (confirm('Are you sure you want to clear all form data?')) {
        document.getElementById('entryForm').reset();
        
        // Clear all account rows except first two
        const container = document.getElementById('accountsContainer');
        while (container.children.length > 2) {
            container.removeChild(container.lastChild);
        }
        
        // Reset account counter
        accountCounter = 2;
        
        // Reset totals
        calculateTotals();
        
        // Focus on date field
        document.getElementById('entry_date').focus();
    }
}

function validateForm(e) {
    const totalDebit = parseFloat(document.getElementById('totalDebit').textContent.replace('₹', ''));
    const totalCredit = parseFloat(document.getElementById('totalCredit').textContent.replace('₹', ''));
    const difference = Math.abs(totalDebit - totalCredit);
    
    if (difference > 0.01) {
        e.preventDefault();
        alert(`Entry is not balanced!\nTotal Debit: ₹${totalDebit.toFixed(2)}\nTotal Credit: ₹${totalCredit.toFixed(2)}\nDifference: ₹${difference.toFixed(2)}\n\nPlease balance your entry before saving.`);
        return false;
    }
    
    // Check if at least two accounts
    const validAccounts = document.querySelectorAll('.account-row').length;
    if (validAccounts < 2) {
        e.preventDefault();
        alert('At least two accounts are required for a journal entry!');
        return false;
    }
    
    return true;
}
</script>
{% endblock %}